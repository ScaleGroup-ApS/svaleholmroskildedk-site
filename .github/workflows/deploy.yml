name: Scaleweb.dk Deployment

on:
  push:
    branches:
      - main

env:
  REGISTRY: registry.scaleweb.dk
  IMAGE_NAME: ${{ github.event.repository.name }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    outputs:
      short-sha: ${{ steps.meta.outputs.short-sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (tags, labels)
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Building image with tag: ${SHORT_SHA}"

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --file ./Dockerfile \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.short-sha }} \
            --push \
            --label org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }} \
            --label org.opencontainers.image.revision=${{ github.sha }} \
            --label org.opencontainers.image.created=${{ github.event.head_commit.timestamp }} \
            .

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set namespace
        run: |
          # Namespace is the repo name without the -site suffix
          REPO_NAME="${{ github.event.repository.name }}"
          NAMESPACE=$(echo "$REPO_NAME" | sed 's/-site$//')
          echo "Using namespace: $NAMESPACE"
          echo "NAMESPACE=$NAMESPACE" >> "$GITHUB_ENV"

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Prepare manifests
        run: |
          sed -i "s/{{CUSTOMER_SLUG}}/$NAMESPACE/g" infra/deployment.yaml
          sed -i "s/{{CUSTOMER_ID}}/${NAMESPACE}/g" infra/deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f infra/deployment.yaml \
            || (kubectl delete -f infra/deployment.yaml --ignore-not-found && kubectl apply -f infra/deployment.yaml)

      - name: Deploy with image tags
        env:
          SHORT_SHA: ${{ needs.build-and-push.outputs.short-sha }}
        run: |
          echo "Deploying with image tag: ${SHORT_SHA}"

          kubectl set image deployment/customer-site \
            customer-site=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SHORT_SHA} \
            -n "$NAMESPACE"

          echo "Waiting for rollouts..."
          kubectl rollout status deployment/customer-site -n "$NAMESPACE" --timeout=5m

          echo "All deployments rolled out successfully"
